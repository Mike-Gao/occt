puts "============"
puts "OCC28091"
puts "============"
puts ""
######################################################
# Crash in Boolean operation in OCCT 6.7.0 version
######################################################

proc FindFaces { boolres } {
  upvar ${boolres} ${boolres}
  
  global result
  global ListCanEdges
  
  foreach ff [explode $boolres f] {
    set HasSame 0
    foreach ee [explode $ff e] {
      foreach fc $ListCanEdges {
        upvar ${fc} ${fc}
        if { [regexp "shapes are not same" [ compare $ee $fc ] full ] == 0 } {
          set HasSame 1
          break
        }
      }
      
      if { $HasSame != 0 } {
        break;
      }    
    }

    if { $HasSame == 0 } {
      add $ff result
    }  
  }  
}

# The main idea of the test is: obtain set of faces
# (which will be stored in "result" compound).
# Set of faces must be closed in U-direction.

compound result

cylinder cylf5 282.33707384194577000000 343.88276232635343000000 884.22469835152799000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 187.00000000000000000000
mkface fcan5 cylf5 0.0 6.28318530717958620000 -899.22469835152799000000 -854.22469835152799000000

cylinder cylf7 418.35216433317999000000 67.43903712333667500000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan7 cylf7 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

cylinder cylf8 146.32198335069199000000 67.43903712333667500000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan8 cylf8 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

cylinder cylf9 67.33707384193599000000 343.88276232633768000000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan9 cylf9 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

cylinder cylf10 282.33707384193599000000 557.88276232633768000000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan10 cylf10 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

cylinder cylf11 496.33707384193599000000 343.88276232633768000000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan11 cylf11 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

cylinder cylf12 282.33707384193599000000 129.88276232633768000000 15.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 6.00000000000000000000
mkface fcan12 cylf12 0.0 6.28318530717958620000 -30.00000000000000000000 15.00000000000000000000

binrestore [locate_data_file bug28091_616101.brep] sh
explode sh

nexplode sh_5 e
nexplode sh_7 e
nexplode sh_8 e
nexplode sh_9 e
nexplode sh_10 e
nexplode sh_11 e
nexplode sh_12 e

compound sh_5_2 sh_5_3 sh_5_4 cmpde5
compound sh_7_1 sh_7_3 sh_7_4 cmpde7
compound sh_8_1 sh_8_3 sh_8_4 cmpde8
compound sh_9_1 sh_9_3 sh_9_4 cmpde9
compound sh_10_1 sh_10_3 sh_10_4 cmpde10
compound sh_11_1 sh_11_3 sh_11_4 cmpde11
compound sh_12_1 sh_12_3 sh_12_4 cmpde12

set FacesList {5 7 8 9 10 11 12}

###################

foreach x $FacesList {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 3 -face 3
  FindFaces res${x}
}

checknbshapes result -face [ llength $FacesList ]
checkprops result -s 21017.3

smallview
donly result
fit
erase axes

checkview -screenshot -2d -path ${imagedir}/${test_image}.png 
