puts "============"
puts "OCC28091"
puts "============"
puts ""
######################################################
# Crash in Boolean operation in OCCT 6.7.0 version
######################################################

proc FindFaces { boolres } {
  upvar ${boolres} ${boolres}
  
  global result
  global ListCanEdges
  
  foreach ff [explode $boolres f] {
    set HasSame 0
    foreach ee [explode $ff e] {
      foreach fc $ListCanEdges {
        upvar ${fc} ${fc}
        if { [regexp "shapes are not same" [ compare $ee $fc ] full ] == 0 } {
          set HasSame 1
          break
        }
      }
      
      if { $HasSame != 0 } {
        break;
      }    
    }

    if { $HasSame == 0 } {
      add $ff result
    }  
  }  
}

# The main idea of the test is: obtain set of faces
# (which will be stored in "result" compound).
# Set of faces must be closed in U-direction.

compound result

cylinder cylf2 13.96415221911074200000 20.33312885278508700000 8.39403909469959860000 0.28665012516263805000 -0.43666337015615425000 -0.85273489837587468000 0.81818652273596726000 0.57463162728365791000 -0.01921736034324384200 1.47068324618069530000
mkface fcan2 cylf2 0.0 6.28318530717958620000 -6.57208607325704900000 13.14417214651409800000

cylinder cylf10 11.92790137880043800000 23.43501535609191000000 14.45153567662009100000 0.28665012516263849000 -0.43666337015615414000 -0.85273489837587468000 -0.12992951695923394000 0.86414424595674832000 -0.48618210868211037000 3.32307707578836010000
mkface fcan10 cylf10 0.0 6.28318530717958620000 -7.10361050480950240000 14.20722100961900500000

binrestore [locate_data_file bug28091_stufenbohrung_raum.brep] sh
explode sh

nexplode sh_2 e
nexplode sh_3 e
nexplode sh_4 e
nexplode sh_5 e

compound sh_2_2 sh_2_3 sh_3_2 sh_3_3 cmpde2
compound sh_4_3 sh_4_4 sh_5_1 sh_5_2 cmpde10

set FacesList {2 10}

###################

foreach x $FacesList {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 3 -face 3
  FindFaces res${x}
}

checknbshapes result -face [ expr [ llength $FacesList ] ]
checkprops result -s 209.05

smallview
donly result
fit
erase axes

checkview -screenshot -2d -path ${imagedir}/${test_image}.png 
