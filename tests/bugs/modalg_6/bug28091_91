puts "============"
puts "OCC28091"
puts "============"
puts ""
######################################################
# Crash in Boolean operation in OCCT 6.7.0 version
######################################################

proc FindFaces { boolres } {
  upvar ${boolres} ${boolres}
  
  global result
  global ListCanEdges
  
  foreach ff [explode $boolres f] {
    set HasSame 0
    foreach ee [explode $ff e] {
      foreach fc $ListCanEdges {
        upvar ${fc} ${fc}
        if { [regexp "shapes are not same" [ compare $ee $fc ] full ] == 0 } {
          set HasSame 1
          break
        }
      }
      
      if { $HasSame != 0 } {
        break;
      }    
    }

    if { $HasSame == 0 } {
      add $ff result
    }  
  }  
}

# The main idea of the test is: obtain set of faces
# (which will be stored in "result" compound).
# Set of faces must be closed in U-direction.

compound result

cylinder cylf1 27.29150262212920100000 65.00000000000000000000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 6.00000000000000000000
mkface fcan1 cylf1 0.0 6.28318530717958620000 -2.70849737787079900000 5.41699475574159810000

cylinder cylf4 22.00000000000000000000 65.00000000000009900000 38.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.99983060107758093000 0.01840568251500763000 0.00000000000000000000 8.00000000000000000000
mkface fcan4 cylf4 0.0 6.28318530717958620000 -26.00000000000000000000 52.00000000000000000000

cylinder cylf5 27.29150262212920100000 490.00000000000000000000 19.00000000000000700000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 5.99999999999998130000
mkface fcan5 cylf5 0.0 6.28318530717958620000 -2.70849737787079900000 5.41699475574159810000

cylinder cylf8 22.00000000000000400000 489.99999999999983000000 38.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.99983060107758037000 0.01840568251503782400 0.00000000000000000000 7.99999999999999910000
mkface fcan8 cylf8 0.0 6.28318530717958620000 -26.00000000000000000000 52.00000000000000000000

cylinder cylf15 0.00000000000000000000 39.99999999999999300000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -0.00000000000000000000 0.00000000000000142109 1.00000000000000000000 5.00000000000000000000
mkface fcan15 cylf15 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000

cylinder cylf17 0.00000000000000000000 515.00000000000000000000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 5.00000000000000000000
mkface fcan17 cylf17 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000

cylinder cylf19 0.00000000000000000000 277.50000000000000000000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 5.00000000000000000000
mkface fcan19 cylf19 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000

cylinder cylf21 0.00000000000000000000 490.00000000000023000000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -0.00000000000000000000 0.00171446966710201870 0.99999853029580033000 6.00000000000000000000
mkface fcan21 cylf21 0.0 6.28318530717958620000 -16.70849737787079900000 33.41699475574159800000

cylinder cylf22 0.00000000000000000000 65.00000000000029800000 19.00000000000000000000 1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -0.00000000000000000000 0.00171446966709728080 0.99999853029580033000 6.00000000000000090000
mkface fcan22 cylf22 0.0 6.28318530717958620000 -16.70849737787079900000 33.41699475574159800000

cylinder cylf29 600.00000000000000000000 490.00000000000034000000 19.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00648490735136420060 -0.99997897276724990000 5.99999999999999910000
mkface fcan29 cylf29 0.0 6.28318530717958620000 -16.70849737787102600000 33.41699475574205300000

cylinder cylf30 577.99999999999989000000 490.00000000000807000000 37.99999999999999300000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.99983060107759858000 0.01840568251405005600 0.00000000000000000000 8.00000000000001420000
mkface fcan30 cylf30 0.0 6.28318530717958620000 -25.99999999999999300000 51.99999999999998600000

cylinder cylf31 572.70849737787103000000 490.00000000000000000000 18.99999999999999300000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 6.00000000000001870000
mkface fcan31 cylf31 0.0 6.28318530717958620000 -2.70849737787102640000 5.41699475574205280000

cylinder cylf35 600.00000000000000000000 65.00000000000118000000 19.00000000000000400000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00648490735120551590 -0.99997897276725090000 6.00000000000000000000
mkface fcan35 cylf35 0.0 6.28318530717958620000 -16.70849737787102600000 33.41699475574205300000

cylinder cylf36 578.00000000000011000000 64.99999999999796800000 38.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.99983060107757549000 0.01840568251530781300 0.00000000000000000000 7.99999999999999730000
mkface fcan36 cylf36 0.0 6.28318530717958620000 -26.00000000000000000000 52.00000000000000000000

cylinder cylf37 572.70849737787103000000 65.00000000000000000000 19.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.00000000000000000000 6.00000000000000440000
mkface fcan37 cylf37 0.0 6.28318530717958620000 -2.70849737787102640000 5.41699475574205280000

cylinder cylf43 600.00000000000000000000 277.50000000000000000000 19.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 5.00000000000000000000
mkface fcan43 cylf43 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000

cylinder cylf45 600.00000000000000000000 40.00000000000000000000 19.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 4.99999999999999730000
mkface fcan45 cylf45 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000

cylinder cylf47 600.00000000000000000000 515.00000000000000000000 19.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 5.00000000000000000000
mkface fcan47 cylf47 0.0 6.28318530717958620000 -20.00000000000000000000 40.00000000000000000000


binrestore [locate_data_file bug28091_Platte_mit_Minifix.brep] sh
explode sh

nexplode sh_1  e
nexplode sh_3  e
nexplode sh_5  e
nexplode sh_7  e
nexplode sh_9  e
nexplode sh_11 e
nexplode sh_19 e
nexplode sh_20 e
nexplode sh_21 e
nexplode sh_23 e
nexplode sh_24 e
nexplode sh_25 e
nexplode sh_27 e
nexplode sh_28 e
nexplode sh_29 e
nexplode sh_31 e
nexplode sh_32 e
nexplode sh_33 e
nexplode sh_35 e
nexplode sh_37 e
nexplode sh_39 e
nexplode sh_41 e


compound sh_23_1 sh_23_2 sh_24_1 sh_24_2 cmpde1
compound sh_39_4 sh_39_1 sh_39_2 sh_39_3 sh_39_5 sh_39_6 cmpde4
compound sh_19_1 sh_19_2 sh_20_1 sh_20_2 cmpde5
compound sh_37_4 sh_37_1 sh_37_2 sh_37_3 sh_37_5 sh_37_6 cmpde8
compound sh_7_1 sh_7_3 cmpde15
compound sh_9_1 sh_9_3 cmpde17
compound sh_11_1 sh_11_3 cmpde19
compound sh_21_1 sh_21_3 sh_21_4 cmpde21
compound sh_25_1 sh_25_3 sh_25_4 cmpde22
compound sh_29_1 sh_29_2 sh_29_3 sh_29_5 cmpde29
compound sh_35_1 sh_35_2 sh_35_3 sh_35_4 sh_35_5 sh_35_6 sh_35_7 cmpde30
compound sh_27_1 sh_27_2 sh_28_1 sh_28_2 cmpde31
compound sh_33_1 sh_33_2 sh_33_3 sh_33_5 cmpde35
compound sh_41_1 sh_41_2 sh_41_3 sh_41_4 sh_41_5 sh_41_6 sh_41_7 cmpde36
compound sh_31_1 sh_31_2 sh_32_1 sh_32_2 cmpde37
compound sh_1_1 sh_1_3 cmpde43
compound sh_3_3 sh_3_1 cmpde45
compound sh_5_1 sh_5_3 cmpde47


set FacesList {15 17 19 21 22 29 35 43 45 47}
set FacesList1 {1 5 31 37}
set FacesList2 {4 8 30 36}


###################

foreach x $FacesList {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 3 -face 3
  FindFaces res${x}
}

foreach x $FacesList1 {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 4 -face 4
  FindFaces res${x}
}

foreach x $FacesList2 {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 7 -face 6
  FindFaces res${x}
}


checknbshapes result -face [ expr [ llength $FacesList ]+2*[ llength $FacesList1 ]+4*[ llength $FacesList2 ] ]
checkprops result -s 11496.4

smallview
donly result
fit
erase axes

checkview -screenshot -2d -path ${imagedir}/${test_image}.png 
