puts "============"
puts "OCC28091"
puts "============"
puts ""
######################################################
# Crash in Boolean operation in OCCT 6.7.0 version
######################################################

proc FindFaces { boolres } {
  upvar ${boolres} ${boolres}
  
  global result
  global ListCanEdges
  
  foreach ff [explode $boolres f] {
    set HasSame 0
    foreach ee [explode $ff e] {
      foreach fc $ListCanEdges {
        upvar ${fc} ${fc}
        if { [regexp "shapes are not same" [ compare $ee $fc ] full ] == 0 } {
          set HasSame 1
          break
        }
      }
      
      if { $HasSame != 0 } {
        break;
      }    
    }

    if { $HasSame == 0 } {
      add $ff result
    }  
  }  
}

# The main idea of the test is: obtain set of faces
# (which will be stored in "result" compound).
# Set of faces must be closed in U-direction.

compound result

cone conf1 17.49915534244081500000 2.75000000000002350000 21.50000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -0.00000000000000000000 -0.00000000000000373970 44.99999999999998600000 4.74999999999997690000
mkface fcan1 conf1 0.0 6.28318530717958620000 -2.25000000000002400000 4.50000000000004800000

cylinder cylf2 17.49915534244081500000 2.75000000000000000000 21.50000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000373970 4.75000000000000000000
mkface fcan2 cylf2 0.0 6.28318530717958620000 -17.25000000000000000000 34.50000000000000000000

cylinder cylf3 17.49915534244081500000 0.00000000000000000000 21.50000000000000000000 0.00000000000000000000 1.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000355271 7.00000000000000000000
mkface fcan3 cylf3 0.0 6.28318530717958620000 -0.50000000000000000000 1.00000000000000000000

cylinder cylf11 182.60536007911978000000 571.25391324377767000000 21.50000000000001800000 -0.95153384789598372000 0.30754403962402360000 0.00000000000000000000 -0.00000000000000022402 -0.00000000000000069311 1.00000000000000000000 11.99999999999998200000
mkface fcan11 cylf11 0.0 6.28318530717958620000 -1.50000000000007330000 3.00000000000014650000

cylinder cylf13 204.13344285278077000000 637.86128259650275000000 21.50000000000001400000 -0.95153384789596396000 0.30754403962408455000 0.00000000000000000000 -0.00000000000000022402 -0.00000000000000069311 1.00000000000000000000 11.99999999999998800000
mkface fcan13 cylf13 0.0 6.28318530717958620000 -1.49999999999977570000 2.99999999999955150000

cylinder cylf15 202.70614208093713000000 638.32259865593892000000 21.50000000000001400000 -0.95153384789598749000 0.30754403962401156000 0.00000000000000000000 -0.00000000000003662943 -0.00000000000011333057 1.00000000000000000000 4.00000000000000710000
mkface fcan15 cylf15 0.0 6.28318530717958620000 -13.94379826352673000000 27.88759652705346100000

cylinder cylf16 187.19811460449708000000 643.33492840883753000000 21.50000000000000000000 0.95153384789600659000 -0.30754403962395255000 0.00000000000000000000 -0.30754403962395255000 -0.95153384789600659000 -0.00000000000000355271 6.00000000000015450000
mkface fcan16 cylf16 0.0 6.28318530717958620000 -0.36666627823598541000 0.73333255647197082000

cone conf17 189.43814606495692000000 642.61093070160155000000 21.50000000000000000000 -0.95153384789600393000 0.30754403962396115000 0.00000000000000000000 -0.30754403962396115000 -0.95153384789600393000 0.00000000000000355271 45.00000000002363300000 4.00000000000030110000
mkface fcan17 conf17 0.0 6.28318530717958620000 -1.99999999999853230000 3.99999999999706460000

cylinder cylf18 181.17805930727584000000 571.71522930321407000000 21.50000000000001800000 -0.95153384789598627000 0.30754403962401555000 0.00000000000000000000 -0.00000000000003662943 -0.00000000000011333057 1.00000000000000000000 4.00000000000000360000
mkface fcan18 cylf18 0.0 6.28318530717958620000 -11.95120398358866300000 23.90240796717732500000

cylinder cylf19 167.56605273332070000000 576.11474856192967000000 21.50000000000000000000 0.95153384789593232000 -0.30754403962418225000 0.00000000000000000000 -0.30754403962418225000 -0.95153384789593243000 -0.00000000000000355271 5.99999999999976460000
mkface fcan19 cylf19 0.0 6.28318530717958620000 -0.36666627823682046000 0.73333255647364093000

cone conf20 169.80608419378072000000 575.39075085469312000000 21.50000000000000000000 -0.95153384789597995000 0.30754403962403498000 0.00000000000000000000 -0.30754403962403504000 -0.95153384789598006000 0.00000000000000355271 45.00000000001099200000 4.00000000000011550000
mkface fcan20 conf20 0.0 6.28318530717958620000 -1.99999999999879120000 3.99999999999758240000


binrestore [locate_data_file bug28091_PL004_LegTimber.brep] sh
explode sh

nexplode sh_8 e
nexplode sh_10 e
nexplode sh_12 e
nexplode sh_13 e
nexplode sh_14 e
nexplode sh_15 e
nexplode sh_16 e
nexplode sh_17 e
nexplode sh_52 e
nexplode sh_53 e
nexplode sh_54 e

compound sh_52_1 sh_52_2 cmpde1
compound sh_53_1 sh_53_2 cmpde2
compound sh_54_1 sh_54_2 cmpde3
compound sh_8_1 sh_8_3   cmpde11
compound sh_10_1 sh_10_3 cmpde13
compound sh_16_1 sh_16_2 sh_16_4 cmpde15
compound sh_12_1 sh_12_2 cmpde16
compound sh_13_2 sh_13_3 sh_13_4 cmpde17
compound sh_17_1 sh_17_2 sh_17_4 cmpde18
compound sh_14_1 sh_14_2 cmpde19
compound sh_15_2 sh_15_3 sh_15_4 cmpde20

set FacesList {1 2 3 11 13 15 16 17 18 19 20}

###################

foreach x $FacesList {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 3 -face 3
  FindFaces res${x}
}

checknbshapes result -face [ llength $FacesList ]
checkprops result -s 1721.88

smallview
donly result
fit
erase axes

checkview -screenshot -2d -path ${imagedir}/${test_image}.png 
