puts "============"
puts "OCC28091"
puts "============"
puts ""
######################################################
# Crash in Boolean operation in OCCT 6.7.0 version
######################################################

proc FindFaces { boolres } {
  upvar ${boolres} ${boolres}
  
  global result
  global ListCanEdges
  
  foreach ff [explode $boolres f] {
    set HasSame 0
    foreach ee [explode $ff e] {
      foreach fc $ListCanEdges {
        upvar ${fc} ${fc}
        if { [regexp "shapes are not same" [ compare $ee $fc ] full ] == 0 } {
          set HasSame 1
          break
        }
      }
      
      if { $HasSame != 0 } {
        break;
      }    
    }

    if { $HasSame == 0 } {
      add $ff result
    }  
  }  
}

# The main idea of the test is: obtain set of faces
# (which will be stored in "result" compound).
# Set of faces must be closed in U-direction.

compound result

cylinder cylf17 360.64999999999998000000 363.50000000000000000000 46.70113780300000200000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan17 cylf17 0.0 6.28318530717958620000 -4.89638218170246380000 9.79276436340492750000

cylinder cylf18 291.64999999999998000000 363.50000000000000000000 22.38363787700000200000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 2.50000000000000000000
mkface fcan18 cylf18 0.0 6.28318530717958620000 -11.49954648770972900000 22.99909297541945800000

cylinder cylf19 227.64999999999998000000 70.19999999999998900000 10.60964709900000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 2.50000000000000000000
mkface fcan19 cylf19 0.0 6.28318530717958620000 -10.28817934401115900000 20.57635868802231700000

cylinder cylf20 243.64999999999998000000 70.19999999999998900000 5.00403228700000020000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan20 cylf20 0.0 6.28318530717958620000 -3.34716577815097920000 6.69433155630195830000

cylinder cylf21 243.64999999999998000000 363.50000000000000000000 5.00403228700000020000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan21 cylf21 0.0 6.28318530717958620000 -3.34716577815097960000 6.69433155630195920000

cylinder cylf23 62.64999999999997700000 363.50000000000000000000 46.70113780300000200000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan23 cylf23 0.0 6.28318530717958620000 -4.89631848427361400000 9.79263696854722810000

cylinder cylf24 131.64999999999998000000 363.50000000000000000000 22.38363787700000200000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 2.50000000000000000000
mkface fcan24 cylf24 0.0 6.28318530717958620000 -11.49961430186068500000 22.99922860372137000000

cylinder cylf25 195.64999999999998000000 70.19999999999998900000 10.60964709900000000000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 2.50000000000000000000
mkface fcan25 cylf25 0.0 6.28318530717958620000 -10.28818699967075300000 20.57637399934150600000

cylinder cylf26 179.64999999999998000000 70.19999999999998900000 5.00403228700000020000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan26 cylf26 0.0 6.28318530717958620000 -3.34715305449755360000 6.69430610899510730000

cylinder cylf27 179.64999999999998000000 363.50000000000000000000 5.00403228700000020000 0.00000000000000000000 0.00000000000000000000 -1.00000000000000000000 -1.00000000000000000000 0.00000000000000000000 0.00000000000000000000 1.50000000000000000000
mkface fcan27 cylf27 0.0 6.28318530717958620000 -3.34715305449755270000 6.69430610899510550000


binrestore [locate_data_file bug28091_facade.brep] sh
explode sh

nexplode sh_17 e
nexplode sh_18 e
nexplode sh_19 e
nexplode sh_20 e
nexplode sh_21 e
nexplode sh_23 e
nexplode sh_24 e
nexplode sh_25 e
nexplode sh_26 e
nexplode sh_27 e
nexplode sh_29 e
nexplode sh_31 e
nexplode sh_33 e
nexplode sh_35 e
nexplode sh_37 e
nexplode sh_39 e
nexplode sh_41 e
nexplode sh_43 e
nexplode sh_45 e
nexplode sh_47 e

compound sh_17_2 sh_17_3 sh_47_2 sh_47_3 cmpde17
compound sh_18_3 sh_43_3 sh_18_2 sh_43_2 cmpde18
compound sh_19_3 sh_39_3 sh_19_2 sh_39_2 cmpde19
compound sh_20_3 sh_33_3 sh_20_2 sh_33_2 cmpde20
compound sh_21_3 sh_29_3 sh_21_2 sh_29_2 cmpde21
compound sh_23_3 sh_45_3 sh_45_2 sh_23_2 cmpde23
compound sh_24_3 sh_41_3 sh_24_2 sh_41_2 cmpde24
compound sh_25_3 sh_37_3 sh_25_2 sh_37_2 cmpde25
compound sh_26_3 sh_35_3 sh_26_2 sh_35_2 cmpde26
compound sh_27_3 sh_31_3 sh_27_2 sh_31_2 cmpde27

set FacesList {17 18 19 20 21 23 24 25 26 27}

###################

foreach x $FacesList {
  set ListCanEdges [ explode fcan${x} e ]

  bclearobjects
  bcleartools
  baddobjects fcan${x}
  baddctools cmpde${x}
  bfillds
  bbuild res${x}

  checknbshapes res${x} -wire 3 -face 3
  FindFaces res${x}
}

checknbshapes result -face [ llength $FacesList ]
checkprops result -s 850.449

smallview
donly result
fit
erase axes

checkview -screenshot -2d -path ${imagedir}/${test_image}.png 
